## Context

MetaCubeXD 的 Connections 页面通过 WebSocket 实时获取活跃连接数据。连接关闭后，数据立即从列表中移除，用户无法查看历史连接信息。

**关键限制**: 纯前端 IndexedDB 方案只能在标签页打开期间采集数据，无法实现 24/7 持续记录。

## Goals / Non-Goals

**Goals:**

- 提供可选的配套数据采集服务，持续记录连接历史
- 使用 SQLite 作为持久化存储
- 前端查询和展示历史数据
- 支持筛选、导出功能

**Non-Goals:**

- 不存储连接的实际数据内容（仅元数据）
- 不提供云端同步功能
- 不强制用户部署配套服务（无服务时显示提示）

## Decisions

### 1. 架构设计

**决定**: 采用可选配套服务架构

```
┌─────────────────┐     WebSocket      ┌─────────────────┐
│   Mihomo Core   │ ◄────────────────► │  Data Collector │
└─────────────────┘                    │    (Go/Rust)    │
                                       └────────┬────────┘
                                                │ SQLite
                                       ┌────────▼────────┐
                                       │   data.db       │
                                       └────────┬────────┘
                                                │ REST API
┌─────────────────┐                    ┌────────▼────────┐
│  MetaCubeXD UI  │ ◄────────────────► │  Query Service  │
└─────────────────┘                    └─────────────────┘
```

**理由**:

- 24/7 持续采集，不依赖浏览器标签页
- SQLite 轻量级，无需额外数据库服务
- 可与 Mihomo 同机部署，资源占用低

### 2. 采集服务技术选型

**决定**: 使用 Go 语言编写采集服务

**理由**:

- 与 Mihomo 技术栈一致
- 单二进制文件分发，部署简单
- 内存占用低，适合长期运行
- 原生支持 SQLite (mattn/go-sqlite3 或 modernc.org/sqlite)

**备选方案**:

- Rust - 性能更好，但生态不如 Go 成熟
- Node.js - 内存占用较高

### 3. 数据采集方式

**决定**: 订阅 Mihomo 的 `/connections` WebSocket，监听连接变化

**理由**:

- 使用现有 API，无需修改 Mihomo
- 可检测连接关闭事件（从列表消失即为关闭）

### 4. 前端集成

**决定**:

- 前端检测采集服务是否可用
- 可用时显示历史功能，不可用时显示部署引导
- 采集服务地址可配置

**理由**:

- 渐进式体验，不强制依赖
- 用户可按需启用高级功能

### 5. 容量管理

**决定**:

- 服务端配置保留策略（默认 7 天或 100000 条）
- 提供 API 供前端触发清理

## Risks / Trade-offs

| 风险                       | 缓解措施                               |
| -------------------------- | -------------------------------------- |
| 用户需要额外部署服务       | 提供 Docker Compose 一键部署，详细文档 |
| 采集服务与 Mihomo 连接断开 | 实现自动重连，记录断连时间段           |
| SQLite 并发写入性能        | 使用 WAL 模式，批量写入                |
| 安全风险（未授权访问）     | 支持 API Token 认证                    |

## API 设计草案

```
GET  /api/connections/history?from=&to=&host=&limit=&offset=
GET  /api/connections/stats
POST /api/connections/cleanup
GET  /api/health
```
