import{V as Z,g as A,y as T,z as J}from"./CRZAT9oH.js";import{m as tt,n as et,s as ot,b as nt,p as at,o as st,q as z,r as rt}from"./BD4k13ts.js";import{u as lt}from"./Dw963Xf9.js";import{e as $}from"./vIF72wqi.js";import{u as ct}from"./lWwe4MHH.js";var it=typeof global=="object"&&global&&global.Object===Object&&global,ut=typeof self=="object"&&self&&self.Object===Object&&self,dt=it||ut||Function("return this")(),I=dt.Symbol,V=Object.prototype,pt=V.hasOwnProperty,ft=V.toString,j=I?I.toStringTag:void 0;function yt(o){var p=pt.call(o,j),y=o[j];try{o[j]=void 0;var v=!0}catch{}var g=ft.call(o);return v&&(p?o[j]=y:delete o[j]),g}var gt=Object.prototype,mt=gt.toString;function ht(o){return mt.call(o)}var wt="[object Null]",bt="[object Undefined]",Q=I?I.toStringTag:void 0;function Tt(o){return o==null?o===void 0?bt:wt:Q&&Q in Object(o)?yt(o):ht(o)}function vt(o){return o!=null&&typeof o=="object"}var Mt="[object Number]";function R(o){return typeof o=="number"||vt(o)&&Tt(o)==Mt}const Pt=Z("connections",()=>{const o=ct(),p=T([]),y=T([]),v=T([]),g=T(null),m=T(!1),w=A("dataUsageMap",{sourceIP:{},host:{},process:{},outbound:{}}),O=A("dataUsageBaseline",{upload:0,download:0});let S=0,C=0;const P=new Map,E=(f,d)=>{const i=new Map;return d.forEach(a=>i.set(a.id,a)),f.map(a=>{const t=i.get(a.id);if(!t||!R(t.download)||!R(t.upload)){const e=a;return{...a,downloadSpeed:e.downloadSpeed??0,uploadSpeed:e.uploadSpeed??0}}return{...a,downloadSpeed:a.download-t.download,uploadSpeed:a.upload-t.upload}})},k=f=>{const d=new Set,i=[];for(const t of p.value)d.has(t.id)||(d.add(t.id),i.push(t));for(const t of f)d.has(t.id)||(d.add(t.id),i.push(t));const a=f.length+$;p.value=a>0&&i.length>a?i.slice(-a):i},G=(f,d)=>{const i=new Set(f.map(a=>a.id));return d.filter(a=>!i.has(a.id))},L=()=>{P.clear(),O.value={upload:0,download:0},console.log("[Data Usage] Connection tracking reset due to service restart")},B=()=>{w.value={sourceIP:{},host:{},process:{},outbound:{}},P.clear()},N=(f,d)=>{const i={...w.value},a={...i[f]};delete a[d],i[f]=a,w.value=i},H=f=>{const d=f?new Set(f.map(i=>i.id)):new Set(p.value.map(i=>i.id));P.forEach((i,a)=>{d.has(a)||P.delete(a)})},F=f=>{g.value=f;const d=f?.connections,i=f?.uploadTotal||0,a=f?.downloadTotal||0;if((i<S||a<C)&&(L(),B(),o.clearChartHistory()),S=i,C=a,!d||d.length===0)return;const t=E(d,y.value);if(_(t),H(t),k(t),!m.value){const e=G(t,p.value);y.value=t,v.value=e.slice(-$)}},_=f=>{const d=g.value;d?.uploadTotal,d?.downloadTotal;const i={...w.value},a=Date.now(),t={sourceIP:new Map,host:new Map,process:new Map,outbound:new Map};f.forEach(e=>{const r=e.upload||0,c=e.download||0;let s=0,l=0;const u=P.get(e.id);if(u?(s=Math.max(0,r-u.upload),l=Math.max(0,c-u.download)):(s=r,l=c),P.set(e.id,{upload:r,download:c}),s===0&&l===0)return;const n=(b,M)=>{if(!M)return;t[b].has(M)||t[b].set(M,{upload:0,download:0});const U=t[b].get(M);U.upload+=s,U.download+=l};n("sourceIP",e.metadata.sourceIP||"Inner"),n("host",e.metadata.host||e.metadata.destinationIP),n("process",e.metadata.process||"Unknown");const h=e.chains&&e.chains.length>0?e.chains[0]:"DIRECT";n("outbound",h)}),Object.keys(t).forEach(e=>{const r=t[e],c={...i[e]};let s=!1;r.forEach((l,u)=>{s=!0;const n=c[u];n?c[u]={...n,upload:n.upload+l.upload,download:n.download+l.download,total:n.upload+l.upload+(n.download+l.download),lastSeen:a}:c[u]={type:e,label:u,upload:l.upload,download:l.download,total:l.upload+l.download,firstSeen:a,lastSeen:a}}),s&&(i[e]=c)}),w.value=i},K=J(()=>{const f=Lt(),d={};return y.value.forEach(i=>{i.chains.forEach(a=>{f.isProxyGroup(a)||(d[a]||(d[a]=0),d[a]+=i.downloadSpeed)})}),d});return{allConnections:p,activeConnections:y,closedConnections:v,latestConnectionMsg:g,paused:m,dataUsageMap:w,speedGroupByName:K,updateFromWsMsg:F,clearDataUsage:B,removeDataUsageEntry:N,restructRawMsgToConnection:E}}),Lt=Z("proxies",()=>{const o=lt(),p=Pt(),y=T([]),v=T([]),g=T({}),m=T({}),w=T({}),O=T({}),S=T({}),C=T({}),P=T(!1),E=A("collapsedMap",{}),k=(t,e=!0)=>{const r=t.extra||{},c=Object.keys(r).reduce((s,l)=>{const u=r[l],n=u?.history?.at(-1)?.delay??o.latencyQualityMap.NOT_CONNECTED;return s.allTestUrlLatency[l]=n,s.allTestUrlLatencyHistory[l]=u?.history,s},{allTestUrlLatency:{},allTestUrlLatencyHistory:{}});if(e){const s=t.testUrl||o.urlForLatencyTest;if(!(s in c.allTestUrlLatency)){const u=t.history?.at(-1)?.delay??o.latencyQualityMap.NOT_CONNECTED;c.allTestUrlLatency[s]=u,c.allTestUrlLatencyHistory[s]=t.history}}return c},G=t=>{const e={...m.value},r={...g.value};t.forEach(c=>{const{allTestUrlLatency:s,allTestUrlLatencyHistory:l}=k(c),{udp:u,xudp:n,type:h,now:b,name:M,tfo:U,provider:D=""}=c;e[c.name]={udp:u,xudp:n,type:h,latency:b,latencyTestHistory:l,name:M,tfo:U,provider:D},(Object.values(s).some(X=>X!==o.latencyQualityMap.NOT_CONNECTED)||!r[c.name])&&(r[c.name]=s)}),m.value=e,g.value=r},L=async()=>{const[{providers:t},{proxies:e}]=await Promise.all([tt(),et()]),r=Object.values(e).map(n=>{if(n.all?.length&&!n.testUrl){const{testUrl:h,timeout:b}=t?.[n.name]||{};return{...n,testUrl:h,timeout:b}}return n}),c=[...e.GLOBAL?.all??[],"GLOBAL"],s=Object.values(r).filter(n=>n.all?.length).sort((n,h)=>c.indexOf(n.name)-c.indexOf(h.name)),l=Object.values(t).filter(n=>n.name!=="default"&&n.vehicleType!=="Compatible"),u=[...r,...l.flatMap(n=>n.proxies.filter(h=>!(h.name in e)).map(h=>({...h,provider:n.name})))];y.value=s,v.value=l,G(u)},B=async(t,e)=>{if(await ot(t.name,e),await L(),o.autoCloseConns){const r=p.restructRawMsgToConnection(p.latestConnectionMsg?.connections??[],[]);r.length>0&&r.forEach(({id:c,chains:s})=>{s.includes(t.name)&&nt(c)})}},N=t=>{let e=m.value[t];if(!t||!e)return t;for(;e&&e.latency&&e.latency!==e.name;){const r=m.value[e.latency];if(!r)return e.name;e=r}return e?.name??t};return{proxies:y,proxyProviders:v,latencyMap:g,proxyNodeMap:m,proxyLatencyTestingMap:w,proxyGroupLatencyTestingMap:O,proxyProviderLatencyTestingMap:S,updatingMap:C,isAllProviderUpdating:P,collapsedMap:E,fetchProxies:L,selectProxyInGroup:B,getNowProxyNodeName:N,getLatencyByName:(t,e)=>{const r=e||o.urlForLatencyTest,c=g.value,s=N(t),l=c[s]?.[r],u=c[t]?.[r];if(l!=null)return l;if(u!=null)return u;const n=c[s];if(n&&Object.keys(n).length>0){const b=Object.keys(n),M=n[r]!=null?r:b[0];if(M)return n[M]}const h=c[t];if(h&&Object.keys(h).length>0){const b=Object.keys(h);if(b[0])return h[b[0]]}return o.latencyQualityMap.NOT_CONNECTED},getLatencyHistoryByName:(t,e)=>{const r=m.value[t],c=N(t),s=m.value[c],l=e||o.urlForLatencyTest,u=s?.latencyTestHistory[l]||r?.latencyTestHistory[l];if(u&&u.length)return u;const n=s?.latencyTestHistory||{},b=Object.keys(n)[0];if(b){const x=n[b];if(x&&x.length)return x}const M=r?.latencyTestHistory||{},D=Object.keys(M)[0];if(D){const x=M[D];if(x&&x.length)return x}return[]},isProxyGroup:t=>{const e=m.value[t];return e?["direct","reject","loadbalance"].includes(e.type.toLowerCase())||!!e.latency:!1},proxyLatencyTest:async(t,e,r,c)=>{const s=N(t);w.value[s]=!0;try{const l=r||o.urlForLatencyTest,u=g.value?.[s]||{},{delay:n}=await at(s,e,l,c??o.latencyTestTimeoutDuration);u[l]=n,g.value={...g.value,[s]:u}}catch{const l=r||o.urlForLatencyTest,u=g.value?.[s]||{};u[l]=o.latencyQualityMap.NOT_CONNECTED,g.value={...g.value,[s]:u}}finally{w.value[s]=!1}},proxyGroupLatencyTest:async t=>{O.value[t]=!0;try{const e=y.value.find(r=>r.name===t);await st(t,e?.testUrl||o.urlForLatencyTest,e?.timeout??o.latencyTestTimeoutDuration),await L()}finally{O.value[t]=!1}},updateProviderByProviderName:async t=>{C.value[t]=!0;try{await z(t)}catch{}await L(),C.value[t]=!1},updateAllProvider:async()=>{P.value=!0;try{await Promise.allSettled(v.value.map(t=>z(t.name))),await L()}finally{P.value=!1}},proxyProviderLatencyTest:async t=>{S.value[t]=!0;try{await rt(t),await L()}finally{S.value[t]=!1}}}});let q={};const W=new WeakMap,Y={metric:[{from:0,to:1e3,unit:"B",long:"bytes"},{from:1e3,to:1e6,unit:"kB",long:"kilobytes"},{from:1e6,to:1e9,unit:"MB",long:"megabytes"},{from:1e9,to:1e12,unit:"GB",long:"gigabytes"},{from:1e12,to:1e15,unit:"TB",long:"terabytes"},{from:1e15,to:1e18,unit:"PB",long:"petabytes"},{from:1e18,to:1e21,unit:"EB",long:"exabytes"},{from:1e21,to:1e24,unit:"ZB",long:"zettabytes"},{from:1e24,to:1e27,unit:"YB",long:"yottabytes"}],metric_octet:[{from:0,to:1e3,unit:"o",long:"octets"},{from:1e3,to:1e6,unit:"ko",long:"kilooctets"},{from:1e6,to:1e9,unit:"Mo",long:"megaoctets"},{from:1e9,to:1e12,unit:"Go",long:"gigaoctets"},{from:1e12,to:1e15,unit:"To",long:"teraoctets"},{from:1e15,to:1e18,unit:"Po",long:"petaoctets"},{from:1e18,to:1e21,unit:"Eo",long:"exaoctets"},{from:1e21,to:1e24,unit:"Zo",long:"zettaoctets"},{from:1e24,to:1e27,unit:"Yo",long:"yottaoctets"}],iec:[{from:0,to:Math.pow(1024,1),unit:"B",long:"bytes"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"KiB",long:"kibibytes"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"MiB",long:"mebibytes"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"GiB",long:"gibibytes"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"TiB",long:"tebibytes"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"PiB",long:"pebibytes"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"EiB",long:"exbibytes"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"ZiB",long:"zebibytes"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"YiB",long:"yobibytes"}],iec_octet:[{from:0,to:Math.pow(1024,1),unit:"o",long:"octets"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"Kio",long:"kibioctets"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"Mio",long:"mebioctets"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"Gio",long:"gibioctets"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"Tio",long:"tebioctets"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"Pio",long:"pebioctets"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"Eio",long:"exbioctets"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"Zio",long:"zebioctets"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"Yio",long:"yobioctets"}]};class xt{constructor(p,y){y=Object.assign({units:"metric",precision:1,locale:void 0},q,y),W.set(this,y),Object.assign(Y,y.customUnits);const v=p<0?"-":"";p=Math.abs(p);const g=Y[y.units];if(g){const m=g.find(w=>p>=w.from&&p<w.to);if(m){const w=new Intl.NumberFormat(y.locale,{style:"decimal",maximumFractionDigits:y.precision}),O=m.from===0?v+w.format(p):v+w.format(p/m.from);this.value=O,this.unit=m.unit,this.long=m.long}else this.value=v+p,this.unit="",this.long=""}else throw new Error(`Invalid units specified: ${y.units}`)}toString(){const p=W.get(this);return p.toStringFn?p.toStringFn.bind(this)():`${this.value} ${this.unit}`}}function Ot(o,p){return new xt(o,p)}Ot.defaultOptions=function(o){q=o};export{Pt as a,Ot as b,Tt as c,dt as r,Lt as u};
